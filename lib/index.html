<!DOCTYPE html>

<html>
<head>
  <title>gilk</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" href="/gilk/bootstrap/css/bootstrap.min.css">
  <!-- Code highlighting -->
  <link rel="stylesheet" href="/gilk/prism/prism-hopscotch.css">
</head>
<body>
    <div class="container">
        <nav class="navbar navbar-inverse navbar-static-top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a href="/gilk/">
                    <span class="navbar-brand">gilk</span>
                    </a>
                </div>
            </div>
        </nav>
    </div>
    <div class="container">
      <div id="header">
      </div>
      <div class="sections">
          <h1>index.js</h1>

          <p>&#39;require&#39;d modules</p>
          <div><pre class="language-javascript" data-start="8"><code class="language-javascript">var Promise = require('es6-promise').Promise,
    assign = require('object-assign'),
    fs = require('fs-extra'),
    path = require('path'),
    dox = require('dox'),
    File = require('vinyl'),
    vinylFs = require('vinyl-fs'),
    Mustache = require('mustache'),
    through = require('through'),
    markdown = require('marked');

var root = path.join(__dirname, '..'),
    templates = path.join(root, 'templates'),
    publicSrc = path.join(root, 'public');</code></pre></div>
          <p>Configuration for the Markdown renderer</p>
          <div><pre class="language-javascript" data-start="26"><code class="language-javascript">markdown.setOptions({
    renderer: new markdown.Renderer(),
    gfm: true,
    tables: true,
    breaks: true,
    pedantic: false,
    sanitize: false,
    smartLists: true,
    smartypants: false
});</code></pre></div>
          <p>gilk module API</p>
          <div><pre class="language-javascript" data-start="40"><code class="language-javascript">module.exports = function gilk(config) {</code></pre></div>
          <p>Default configuration</p>
          <div><pre class="language-javascript" data-start="44"><code class="language-javascript">config = assign({
        base: '.',
        dest: '.',</code></pre></div>
          <p>Optional custom Mustache page template</p>
          <div><pre class="language-javascript" data-start="48"><code class="language-javascript">template: null,
markdown: false,
baseurl: '',
title: 'Home',</code></pre></div>
          <p>Optional js script</p>
          <div><pre class="language-javascript" data-start="53"><code class="language-javascript">js: null,</code></pre></div>
          <p>Optional css script</p>
          <div><pre class="language-javascript" data-start="55"><code class="language-javascript">css: null,
'exclude-source': null
        },</code></pre></div>
          <p>Override default properties and add custom properties</p>
          <div><pre class="language-javascript" data-start="59"><code class="language-javascript">config);

    var defaultTmpl = config.markdown ? 'md.tmpl' : 'html.tmpl';
    
    var ext =  config.markdown ? '.md' : '.html';</code></pre></div>
          <p>Retrieve template content</p>
          <div><pre class="language-javascript" data-start="66"><code class="language-javascript">var tmpl = fs.readFileSync(config.template || path.join(templates, defaultTmpl)).toString(),
    sources = [],
    tasks = [];
if (!config.markdown && !config.template) {</code></pre></div>
          <p>stream static resources associated with the default doc template</p>
          <div><pre class="language-javascript" data-start="71"><code class="language-javascript">tasks.push(new Promise(function(resolve) {
    vinylFs.src(path.join(publicSrc, '**/*')).pipe(through(function(resource) {
        stream.queue(resource);
    }, resolve));
}));
    }</code></pre></div>
          <p>The documentation transform stream</p>
          <div><pre class="language-javascript" data-start="79"><code class="language-javascript">var stream = through(function(file) {
    var docFile = renderDocFile(tmpl, file, ext, config);
    var sourcePath = path.relative(file.base, docFile.path);
    sources.push({
        href: sourcePath,
        name: path.join(path.dirname(sourcePath), path.basename(sourcePath, ext)).split(path.sep).join('/')
    });</code></pre></div>
          <p>stream source js file</p>
          <div><pre class="language-javascript" data-start="87"><code class="language-javascript">if (!config['exclude-source']) {
    this.queue(file);
}</code></pre></div>
          <p>stream doc file</p>
          <div><pre class="language-javascript" data-start="91"><code class="language-javascript">this.queue(docFile);
    }, function() {</code></pre></div>
          <p>stream a JSON representation of the TOC</p>
          <div><pre class="language-javascript" data-start="94"><code class="language-javascript">stream.queue(new File({
    path: 'toc.json',
    contents: new Buffer(JSON.stringify(sources))
}));
if (config.index) {</code></pre></div>
          <p>Render the index doc</p>
          <div><pre class="language-javascript" data-start="100"><code class="language-javascript">var index = config.markdown ? 'README.md' : 'index.html';
tasks.push(
    renderIndex(tmpl, sources, config).then(function(contents) {
        stream.queue(new File({
            path: index,
            contents: new Buffer(contents)
        }));
    })
);
        }
        Promise.all(tasks).then(function() {
stream.queue(null);
        }, function(err) {
console.error(err);
        });
    });

    return stream;
};

function renderDocFile(tmpl, file, extension, config) {
    var ext = path.extname(file.path),
        filename = path.basename(file.path, ext);
    var comments = dox.parseComments(file.contents.toString(), {raw: config.markdown});
    var doc = Mustache.render(tmpl,
        assign({
srcfile: path.relative(config.base, file.path),
comments: comments</code></pre></div>
          <p>All <code>config</code> properties are available in the doc template</p>
          <div><pre class="language-javascript" data-start="129"><code class="language-javascript">}, config));
    return assign(file.clone(), {
contents: new Buffer(doc),
path: file.path.replace(/\.js$/, extension)
    });
}

function renderIndex(tmpl, sources, config) {
    return new Promise(function (resolve, reject) {
var ext = path.extname(config.index),
    name = path.basename(config.index, ext);

fs.readFile(config.index, function (err, buf) {
    var md = config.markdown ? buf.toString() : markdown(buf.toString());
    var comments = [{
        description: {
            full: md
        }
    }];
    resolve(Mustache.render(tmpl,
        assign({
            isIndex: true,
            comments: comments,
            toc: {
                sources: sources
            }
        },</code></pre></div>
          <p>All <code>config</code> properties are available in the doc template</p>
          <div><pre class="language-javascript" data-start="157"><code class="language-javascript">config)
            ));
        });
    });
}</code></pre></div>
      </div>
      <hr>
  </div>
  <script type="text/javascript" src="/gilk/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/gilk/bootstrap/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="/gilk/prism/prism.js"></script>
</body>
</html>
